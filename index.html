<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cytoplasm.io</title>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background: #cfd8dc; font-family: 'Segoe UI', sans-serif; touch-action: none; position: fixed; width: 100%; height: 100%; }
        canvas { display: block; }
 
        #ui { position: fixed; top: 15px; left: 15px; pointer-events: none; z-index: 10; display: flex; flex-direction: column; gap: 5px; }
        .score-box { background: rgba(255,255,255,0.9); padding: 8px 15px; border-radius: 15px; border: 2px solid #37474f; font-weight: bold; font-size: 14px; }
        #sprint-status { background: rgba(0,229,255,0.2); color: #00838f; border-color: #00e5ff; display: none; }
        .exhausted { background: rgba(255,87,34,0.2) !important; color: #d84315 !important; border-color: #ff5722 !important; }
        #shield-bar { background: rgba(100,180,255,0.25); color: #1565c0; border-color: #42a5f5; display: none; }
 
        #leaderboard { position: fixed; top: 15px; right: 15px; background: rgba(0,0,0,0.6); color: white; padding: 12px; border-radius: 10px; min-width: 140px; font-size: 12px; z-index: 10; pointer-events: none; }
        #minimap { position: fixed; bottom: 20px; right: 20px; width: 130px; height: 130px; background: rgba(0,0,0,0.4); border: 2px solid #fff; border-radius: 5px; z-index: 5; }
 
        #overlay { position: fixed; inset: 0; background: rgba(38,50,56,0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 100; text-align: center; padding: 20px; }
        #startBtn { padding: 15px 50px; font-size: 20px; background: #0288d1; border: none; color: white; border-radius: 40px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        #death-screen { position: fixed; inset: 0; background: rgba(180,0,0,0.92); display: none; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 100; text-align: center; padding: 20px; }
        #death-screen h1 { font-size: 64px; margin: 0; }
        #respawnBtn { padding: 15px 50px; font-size: 20px; background: white; border: none; color: #c00; border-radius: 40px; font-weight: bold; cursor: pointer; margin-top: 20px; }
 
        /* Victory Screen */
        #victory-screen { position: fixed; inset: 0; background: linear-gradient(135deg, rgba(0,60,20,0.97), rgba(0,100,60,0.97)); display: none; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 100; text-align: center; padding: 20px; }
        #victory-screen h1 { font-size: 60px; margin: 0 0 10px; }
        .victory-stat { font-size: 22px; margin: 8px 0; color: #a5d6a7; }
        .victory-stat span { color: #ffffff; font-weight: bold; }
        #victoryBtn { padding: 15px 50px; font-size: 20px; background: #00e676; border: none; color: #003300; border-radius: 40px; font-weight: bold; cursor: pointer; margin-top: 24px; }
 
        /* Evo Banner */
        #evo-banner { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%) scale(0); z-index: 200; pointer-events: none; opacity: 0; transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1), opacity 0.4s; }
        #evo-banner.show { transform: translate(-50%,-50%) scale(1); opacity: 1; }
        #evo-banner.hide { transform: translate(-50%,-50%) scale(0.7); opacity: 0; }
        #evo-inner { background: rgba(5,15,30,0.97); border: 3px solid #00e5ff; border-radius: 22px; padding: 26px 44px; color: white; box-shadow: 0 0 50px #00e5ff66; text-align: center; }
        #evo-inner h2 { margin: 0 0 8px; font-size: 30px; color: #00e5ff; letter-spacing: 1px; }
        #evo-inner p { margin: 0; font-size: 15px; color: #90a4ae; }
 
        /* Eat Quote Popup */
        #eat-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%) scale(0); z-index: 300; pointer-events: none; opacity: 0; transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1), opacity 0.3s; max-width: 340px; width: 90%; }
        #eat-popup.show { transform: translate(-50%,-50%) scale(1); opacity: 1; }
        #eat-popup.hide { transform: translate(-50%,-50%) scale(0.8); opacity: 0; }
        #eat-popup-inner { background: rgba(10,10,10,0.95); border: 3px solid #ff9800; border-radius: 20px; padding: 20px 28px; color: white; box-shadow: 0 0 40px rgba(255,152,0,0.5); text-align: center; }
        #eat-popup-inner .eat-title { font-size: 20px; font-weight: bold; color: #ff9800; margin-bottom: 8px; }
        #eat-popup-inner .eat-quote { font-size: 14px; color: #ccc; font-style: italic; }
 
        /* Touch Controls */
        #touch-controls { display: none; }
        #joystick-zone { position: fixed; bottom: 20px; left: 20px; width: 160px; height: 160px; pointer-events: all; z-index: 20; }
        #joystick-base { width: 160px; height: 160px; background: rgba(255,255,255,0.12); border: 3px solid rgba(255,255,255,0.35); border-radius: 50%; position: absolute; }
        #joystick-knob { width: 70px; height: 70px; background: rgba(2,136,209,0.8); border: 3px solid #fff; border-radius: 50%; position: absolute; top: 45px; left: 45px; }
        #action-buttons { position: fixed; bottom: 30px; right: 20px; display: flex; flex-direction: column; gap: 14px; align-items: flex-end; pointer-events: all; z-index: 20; }
        .action-btn { width: 72px; height: 72px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.85); font-weight: bold; font-size: 12px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; text-align: center; user-select: none; -webkit-user-select: none; transition: transform 0.1s; }
        .action-btn:active { transform: scale(0.88); }
        #btn-sprint { background: rgba(0,200,255,0.65); }
        #btn-split  { background: rgba(100,200,100,0.65); }
 
        /* Mobile overrides */
        @media (max-width: 600px) {
            #ui { display: none; }
            #minimap { top: 15px; left: 15px; bottom: auto; right: auto; width: 110px; height: 110px; }
            #leaderboard { top: 15px; right: 15px; min-width: 130px; }
            #mobile-mass { display: block; }
        }
        #mobile-mass { display: none; position: fixed; top: 15px; right: 15px; background: rgba(255,255,255,0.92); padding: 7px 14px; border-radius: 12px; border: 2px solid #37474f; font-weight: bold; font-size: 13px; z-index: 10; pointer-events: none; color: #263238; }
    </style>
</head>
<body>
 
<div id="ui">
    <div class="score-box">MASS: <span id="scoreVal">20</span></div>
    <div class="score-box" id="evo-status" style="color:#ab47bc; display:none;"></div>
    <div id="shield-bar" class="score-box">üõ°Ô∏è SHIELD: <span id="shieldVal">10</span>s</div>
    <div id="sprint-status" class="score-box">SPRINTING...</div>
</div>
<div id="mobile-mass">MASS: <span id="mobileScoreVal">20</span></div>
 
<div id="leaderboard"><h3 style="margin:0 0 8px">TOP CELLS</h3><div id="lb-list"></div></div>
<canvas id="minimap"></canvas>
 
<div id="evo-banner"><div id="evo-inner"><h2 id="evo-title"></h2><p id="evo-desc"></p></div></div>
 
<!-- Eat Quote Popup -->
<div id="eat-popup">
    <div id="eat-popup-inner">
        <div class="eat-title" id="eat-title"></div>
        <div class="eat-quote" id="eat-quote"></div>
    </div>
</div>
 
<!-- Touch Controls -->
<div id="touch-controls">
    <div id="joystick-zone"><div id="joystick-base"></div><div id="joystick-knob"></div></div>
    <div id="action-buttons">
        <div class="action-btn" id="btn-sprint">SPRINT</div>
        <div class="action-btn" id="btn-split">SPLIT</div>
    </div>
</div>
 
<div id="overlay">
    <h1>ü¶† CYTOPLASM.IO</h1>
    <p>SPACE: Sprint  |  SHIFT: Split</p>
    <p style="color:#42a5f5; margin:6px 0">üõ°Ô∏è Shielded for first <strong>10 seconds</strong>!</p>
    <p style="color:#ff9800; margin:6px 0">‚ö†Ô∏è Bots grow hungrier and more aggressive over time!</p>
    <p style="color:#ef5350; margin:6px 0">‚ò£Ô∏è Green viruses burst cells over mass 130!</p>
    <p style="color:#111; margin:6px 0">‚ö´ <strong>Black viruses</strong> spew food ‚Äî eat at 20,000 mass!</p>
    <p style="color:#e53935; margin:6px 0">üî¥ <strong>Red viruses</strong> drain 20% mass ‚Äî eat at 10,000 mass!</p>
    <p style="color:#00e676; margin:6px 0">üèÜ Reach <strong>30,000 mass</strong> to WIN!</p>
    <p style="color:#ce93d8; font-size:13px; margin:6px 0">üß¨ Evolve: 1000‚ÜíNucleus | 2000‚ÜíMito | 3000‚ÜíChloro</p>
    <button id="startBtn">SPAWN</button>
</div>
 
<div id="death-screen">
    <h1>üíÄ EATEN!</h1>
    <p id="death-msg" style="font-size:22px; margin:12px 20px;"></p>
    <button id="respawnBtn">RESPAWN</button>
</div>
 
<div id="victory-screen">
    <h1>üèÜ YOU WIN!</h1>
    <p style="font-size:20px; color:#a5d6a7; margin:4px 0;">You conquered the cytoplasm!</p>
    <div class="victory-stat">Final Mass: <span id="v-mass">0</span></div>
    <div class="victory-stat">Time to Victory: <span id="v-time">0:00</span></div>
    <div class="victory-stat">Bots Devoured: <span id="v-bots">0</span></div>
    <button id="victoryBtn">PLAY AGAIN</button>
</div>
 
<canvas id="gameCanvas"></canvas>
 
<script>
const canvas  = document.getElementById('gameCanvas');
const ctx     = canvas.getContext('2d');
const mCanvas = document.getElementById('minimap');
const mCtx    = mCanvas.getContext('2d');
 
const scoreEl        = document.getElementById('scoreVal');
const mobileScoreEl  = document.getElementById('mobileScoreVal');
const mobileMassEl   = document.getElementById('mobile-mass');
const evoStatusEl    = document.getElementById('evo-status');
const shieldBarEl    = document.getElementById('shield-bar');
const shieldValEl    = document.getElementById('shieldVal');
const sprintStatusEl = document.getElementById('sprint-status');
const lbList         = document.getElementById('lb-list');
const deathScreen    = document.getElementById('death-screen');
const deathMsg       = document.getElementById('death-msg');
const victoryScreen  = document.getElementById('victory-screen');
const evoBanner      = document.getElementById('evo-banner');
const evoTitle       = document.getElementById('evo-title');
const evoDesc        = document.getElementById('evo-desc');
const lbEl           = document.getElementById('leaderboard');
const eatPopup       = document.getElementById('eat-popup');
const eatTitleEl     = document.getElementById('eat-title');
const eatQuoteEl     = document.getElementById('eat-quote');
 
const WORLD_SIZE     = 5000;
const MERGE_COOLDOWN = 15000;
const CELL_SCALE     = 5;
const SHIELD_MS      = 10000;
const WIN_MASS       = 30000;
const PHASE1_END     = 60000;
const PHASE2_END     = 120000;
 
// ‚îÄ‚îÄ Bot name/quote roster ‚îÄ‚îÄ
const BOT_ROSTER = [
    { name:'Amy',    full:'Amy the Amoeba',       quote:'She was a blob. A beautiful blob.' },
    { name:'Genie',  full:'Genie the Euglena',     quote:'Couldn\'t decide if she was a plant or animal. Identity crisis solved.' },
    { name:'Para',   full:'Para the Paramecium',   quote:'Covered in tiny hairs. Still didn\'t see you coming.' },
    { name:'Volvie', full:'Volvox',                quote:'She traveled in groups. Apparently the group abandoned her.' },
    { name:'Dino',   full:'Dino the Dinoflagellate',quote:'He glowed in the dark. Not anymore.' },
    { name:'Stylo',  full:'Stylo',                 quote:'Had little legs. Needed bigger ones.' },
    { name:'Bleppy', full:'Bleppy the Blepharisma',quote:'He was pink. He was proud. He was lunch.' },
    { name:'Oxi',    full:'Oxi the Oxytricha',     quote:'A master of disguise. Not disguised enough.' },
    { name:'Vorty',  full:'Vorty the Vorticella',  quote:'Spent her whole life spinning. Dizzy to the end.' },
    { name:'Spiro',  full:'Spiro the Spirostomum', quote:'The longest single-celled organism alive. Key word: was.' },
    { name:'Noctie', full:'Noctiluca',             quote:'Literally bioluminescent. Totally outclassed.' },
    { name:'Diddy',  full:'Didinium',              quote:'He ate Paramecia whole. Ironic, really.' },
    { name:'Chaos',  full:'Chaos the Chaos Difflugia',quote:'His name was Chaos. He was not prepared for you.' },
    { name:'Tetra',  full:'Tetrahymena',           quote:'Used in cancer research. Couldn\'t cure getting eaten.' },
    { name:'Gonium', full:'Gonium',                quote:'A team player. The team lost.' },
    { name:'Stenty', full:'Stenty the Stentor',    quote:'Shaped like a trumpet. Played no final song.' },
    { name:'Peri',   full:'Peridinium',            quote:'Armored with cellulose plates. Not enough plates.' },
    { name:'Gromia', full:'Gromia',                quote:'She rolled across the seafloor. This isn\'t the seafloor.' },
    { name:'Arcey',  full:'Arcella',               quote:'Built a little shell house. Foreclosed.' },
    { name:'Cilia',  full:'Cilia',                 quote:'All those tiny hairs, zero escape velocity.' },
];
 
let width, height, gameActive = false;
let playerCells = [], food = [], bots = [], particles = [], viruses = [], blackViruses = [], redViruses = [], atp = [];
let joyX = 0, joyY = 0, keys = {};
let cameraZoom = 1;
let metabolicBoost = 0;
let sprintBaselineMass = null, sprintCooldownTimer = 0, isSprinting = false;
let gameStartTime = 0, botsEaten = 0, peakMass = 0;
let hasNucleus = false, hasMitochondria = false, hasChloroplasts = false;
let shieldEndTime = 0, lastLBUpdate = 0;
let avgX = 2500, avgY = 2500;
let botRespawnQueue = [];
let usedRosterIndices = [];
 
const MAX_BOTS = 20;
const BOT_START_MASS = 20;
const PLAYER_START_MASS = 20;
const BOT_RESPAWN_DELAY = 60000;
 
const isTouchDevice = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
const isMobile = isTouchDevice && window.innerWidth <= 600;
 
// ‚îÄ‚îÄ Pick a unique bot from roster ‚îÄ‚îÄ
function pickBotEntry() {
    if (usedRosterIndices.length >= BOT_ROSTER.length) usedRosterIndices = [];
    let available = BOT_ROSTER.map((_,i)=>i).filter(i=>!usedRosterIndices.includes(i));
    let idx = available[Math.floor(Math.random()*available.length)];
    usedRosterIndices.push(idx);
    return BOT_ROSTER[idx];
}
 
// ‚îÄ‚îÄ Mobile layout ‚îÄ‚îÄ
function setupMobileLayout() {
    if (!isMobile) return;
    document.getElementById('touch-controls').style.display = 'block';
    function positionMobileMass() {
        let lb = lbEl.getBoundingClientRect();
        mobileMassEl.style.top = (lb.bottom + 8) + 'px';
    }
    positionMobileMass();
    window.addEventListener('resize', positionMobileMass);
    new MutationObserver(positionMobileMass).observe(lbEl, {childList:true,subtree:true});
}
 
// ‚îÄ‚îÄ Evolution ‚îÄ‚îÄ
const MILESTONES = [
    { mass:1000, key:'nucleus',      title:'üß¨ NUCLEUS FORMED!',      desc:'You are now a Eukaryote ‚Äî your DNA is protected!' },
    { mass:2000, key:'mitochondria', title:'‚ö° MITOCHONDRIA EVOLVED!', desc:'The powerhouse of the cell! Permanent speed boost.' },
    { mass:3000, key:'chloroplasts', title:'üåø CHLOROPLASTS EVOLVED!', desc:'You can photosynthesize! Food is now worth 2√ó mass.' },
];
function checkEvolution(totalMass) {
    for (let m of MILESTONES) {
        if (totalMass >= m.mass) {
            if (m.key==='nucleus'      && !hasNucleus)      { hasNucleus=true;      triggerEvo(m); }
            if (m.key==='mitochondria' && !hasMitochondria) { hasMitochondria=true; triggerEvo(m); }
            if (m.key==='chloroplasts' && !hasChloroplasts) { hasChloroplasts=true; triggerEvo(m); }
        }
    }
    let parts=[];
    if(hasNucleus)      parts.push('üß¨ Nucleus');
    if(hasMitochondria) parts.push('‚ö° Mito');
    if(hasChloroplasts) parts.push('üåø Chloro');
    evoStatusEl.style.display = parts.length ? 'block':'none';
    evoStatusEl.innerText = parts.join(' | ');
}
let evoBannerTO=null;
function triggerEvo(m) {
    evoTitle.innerText=m.title; evoDesc.innerText=m.desc;
    evoBanner.className='show';
    if(evoBannerTO) clearTimeout(evoBannerTO);
    evoBannerTO=setTimeout(()=>{ evoBanner.className='hide'; },3800);
}
 
// ‚îÄ‚îÄ Eat Quote Popup ‚îÄ‚îÄ
let eatPopupTO=null;
function showEatPopup(entry) {
    eatTitleEl.innerText = `üòã You ate ${entry.full}!`;
    eatQuoteEl.innerText = entry.quote;
    eatPopup.className='show';
    if(eatPopupTO) clearTimeout(eatPopupTO);
    eatPopupTO=setTimeout(()=>{ eatPopup.className='hide'; }, 2200);
}
 
// ‚îÄ‚îÄ Spatial Grid ‚îÄ‚îÄ
const GRID_CELL=200, GRID_COLS=Math.ceil(WORLD_SIZE/GRID_CELL);
let spatialGrid={};
function buildGrid(entities){
    spatialGrid={};
    for(let e of entities){
        let gx0=Math.max(0,((e.x-e.r)/GRID_CELL)|0),gy0=Math.max(0,((e.y-e.r)/GRID_CELL)|0);
        let gx1=Math.min(GRID_COLS-1,((e.x+e.r)/GRID_CELL)|0),gy1=Math.min(GRID_COLS-1,((e.y+e.r)/GRID_CELL)|0);
        for(let gx=gx0;gx<=gx1;gx++) for(let gy=gy0;gy<=gy1;gy++){
            let k=gx+','+gy; if(!spatialGrid[k]) spatialGrid[k]=[]; spatialGrid[k].push(e);
        }
    }
}
function getNearby(x,y,r){
    let results=new Set();
    let gx0=Math.max(0,((x-r)/GRID_CELL)|0),gy0=Math.max(0,((y-r)/GRID_CELL)|0);
    let gx1=Math.min(GRID_COLS-1,((x+r)/GRID_CELL)|0),gy1=Math.min(GRID_COLS-1,((y+r)/GRID_CELL)|0);
    for(let gx=gx0;gx<=gx1;gx++) for(let gy=gy0;gy<=gy1;gy++){
        let k=gx+','+gy; if(spatialGrid[k]) for(let e of spatialGrid[k]) results.add(e);
    }
    return results;
}
 
// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
function init() {
    let pr=Math.sqrt(PLAYER_START_MASS)*CELL_SCALE;
    playerCells=[{x:WORLD_SIZE/2,y:WORLD_SIZE/2,mass:PLAYER_START_MASS,r:pr,vx:0,vy:0,splitTime:0}];
    food=[]; bots=[]; particles=[]; viruses=[]; blackViruses=[]; redViruses=[]; atp=[]; botRespawnQueue=[]; usedRosterIndices=[];
    metabolicBoost=0; sprintBaselineMass=null; sprintCooldownTimer=0; isSprinting=false;
    hasNucleus=false; hasMitochondria=false; hasChloroplasts=false;
    evoStatusEl.style.display='none'; evoBanner.className=''; eatPopup.className='';
    shieldEndTime=Date.now()+SHIELD_MS; gameStartTime=Date.now(); botsEaten=0; peakMass=0;
 
    for(let i=0;i<700;i++) spawnFood();
    for(let i=0;i<MAX_BOTS;i++) spawnBot();
    for(let i=0;i<15;i++) viruses.push({x:Math.random()*WORLD_SIZE,y:Math.random()*WORLD_SIZE,r:60});
 
    // Black viruses ‚Äî 3, permanent, food-spewing
    for(let i=0;i<3;i++) blackViruses.push({
        x:300+Math.random()*(WORLD_SIZE-600), y:300+Math.random()*(WORLD_SIZE-600),
        r:75, pulseT:Math.random()*Math.PI*2, spewTimer:0
    });
 
    // Red viruses ‚Äî 5, drifting
    for(let i=0;i<5;i++) spawnRedVirus();
 
    for(let i=0;i<30;i++) atp.push({x:Math.random()*WORLD_SIZE,y:Math.random()*WORLD_SIZE,r:10});
 
    deathScreen.style.display='none';
    victoryScreen.style.display='none';
    resize(); setupMobileLayout();
}
 
function spawnRedVirus() {
    let angle=Math.random()*Math.PI*2, speed=0.3+Math.random()*0.4;
    redViruses.push({
        x:200+Math.random()*(WORLD_SIZE-400), y:200+Math.random()*(WORLD_SIZE-400),
        r:55, vx:Math.cos(angle)*speed, vy:Math.sin(angle)*speed,
        pulseT:Math.random()*Math.PI*2
    });
}
 
function spawnFood(ox,oy) {
    food.push({
        x: ox!==undefined ? ox+(Math.random()-.5)*80 : Math.random()*WORLD_SIZE,
        y: oy!==undefined ? oy+(Math.random()-.5)*80 : Math.random()*WORLD_SIZE,
        r:6, c:`hsl(${Math.random()*360},60%,60%)`
    });
}
 
function spawnBot(parent=null,forceVx=0,forceVy=0) {
    let entry=pickBotEntry();
    let mass=parent?parent.mass:BOT_START_MASS;
    let isAggro=Math.random()>0.65;
    bots.push({
        x:parent?parent.x:Math.random()*WORLD_SIZE,
        y:parent?parent.y:Math.random()*WORLD_SIZE,
        mass, r:Math.sqrt(mass)*CELL_SCALE,
        vx:forceVx, vy:forceVy,
        name:entry.name, full:entry.full, quote:entry.quote,
        aggro:isAggro, c:isAggro?'#e53935':`hsl(${Math.random()*360},50%,50%)`,
        splitTime:0, wandX:0, wandY:0
    });
}
 
function queueBotRespawn(){if(botRespawnQueue.length+bots.length<MAX_BOTS) botRespawnQueue.push(Date.now()+BOT_RESPAWN_DELAY);}
function processBotRespawns(now){
    for(let i=botRespawnQueue.length-1;i>=0;i--){
        if(now>=botRespawnQueue[i]&&bots.length<MAX_BOTS){spawnBot();botRespawnQueue.splice(i,1);}
    }
}
 
function resize(){
    width=canvas.width=window.innerWidth; height=canvas.height=window.innerHeight;
    mCanvas.width=mCanvas.height=(isMobile?110:130);
}
window.addEventListener('resize',resize);
 
// ‚îÄ‚îÄ Keyboard ‚îÄ‚îÄ
window.addEventListener('keydown',e=>{
    if(e.code==='Space'){if(Date.now()>sprintCooldownTimer){keys['Space']=true;if(!sprintBaselineMass)sprintBaselineMass=playerCells.reduce((s,c)=>s+c.mass,0);}}
    if(e.code==='ShiftLeft'||e.code==='ShiftRight') splitPlayer();
    if(['KeyW','KeyA','KeyS','KeyD','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code)) keys[e.code]=true;
});
window.addEventListener('keyup',e=>{keys[e.code]=false;});
let mouseX=null,mouseY=null;
canvas.addEventListener('mousemove',e=>{mouseX=e.clientX;mouseY=e.clientY;});
 
// ‚îÄ‚îÄ Touch ‚îÄ‚îÄ
if(isTouchDevice) document.getElementById('touch-controls').style.display='block';
const joystickZone=document.getElementById('joystick-zone');
const joystickKnob=document.getElementById('joystick-knob');
const JOY_R=80;
let joyActive=false,joyTouchId=null,joyBaseX=0,joyBaseY=0,touchJoyX=0,touchJoyY=0;
 
document.addEventListener('touchstart',e=>{
    for(let t of e.changedTouches){
        let el=document.elementFromPoint(t.clientX,t.clientY);
        if(el&&el.id==='btn-sprint'){if(Date.now()>sprintCooldownTimer){keys['Space']=true;if(!sprintBaselineMass)sprintBaselineMass=playerCells.reduce((s,c)=>s+c.mass,0);}continue;}
        if(el&&el.id==='btn-split'){splitPlayer();continue;}
        if(!joyActive&&t.clientX<width*0.5){
            joyTouchId=t.identifier;joyBaseX=t.clientX;joyBaseY=t.clientY;
            joystickZone.style.left=(t.clientX-80)+'px';joystickZone.style.top=(t.clientY-80)+'px';
            joystickKnob.style.left='45px';joystickKnob.style.top='45px';joyActive=true;
        }
    }
},{passive:true});
document.addEventListener('touchmove',e=>{
    for(let t of e.changedTouches){
        if(t.identifier===joyTouchId){
            let dx=t.clientX-joyBaseX,dy=t.clientY-joyBaseY,dist=Math.hypot(dx,dy);
            let c=Math.min(dist,JOY_R),angle=Math.atan2(dy,dx);
            touchJoyX=Math.cos(angle)*(c/JOY_R);touchJoyY=Math.sin(angle)*(c/JOY_R);
            joystickKnob.style.left=(45+Math.cos(angle)*c)+'px';joystickKnob.style.top=(45+Math.sin(angle)*c)+'px';
        }
    }
},{passive:true});
document.addEventListener('touchend',e=>{
    for(let t of e.changedTouches){
        if(t.identifier===joyTouchId){joyActive=false;joyTouchId=null;touchJoyX=0;touchJoyY=0;joystickKnob.style.left='45px';joystickKnob.style.top='45px';}
        let el=document.elementFromPoint(t.clientX,t.clientY);if(el&&el.id==='btn-sprint')keys['Space']=false;
    }
},{passive:true});
 
// ‚îÄ‚îÄ Actions ‚îÄ‚îÄ
function splitPlayer(){
    sprintBaselineMass=null; let newC=[];
    playerCells.forEach(c=>{
        if(c.mass>=40&&playerCells.length<16){
            c.mass/=2;c.r=Math.sqrt(c.mass)*CELL_SCALE;
            newC.push({x:c.x,y:c.y,mass:c.mass,r:c.r,vx:(joyX||1)*30,vy:(joyY||0)*30,splitTime:Date.now()});
        }
    });
    playerCells.push(...newC);
}
function burstCell(cell,array){
    let pieces=8,sm=cell.mass/pieces; if(sm<10)return;
    cell.mass=sm;cell.r=Math.sqrt(sm)*CELL_SCALE;cell.splitTime=Date.now();
    for(let i=1;i<pieces;i++){let a=(Math.PI*2/pieces)*i;array.push({x:cell.x,y:cell.y,mass:sm,r:Math.sqrt(sm)*CELL_SCALE,vx:Math.cos(a)*25,vy:Math.sin(a)*25,splitTime:Date.now()});}
}
function playerDied(killer){
    gameActive=false;
    let fm=playerCells.reduce((s,c)=>s+c.mass,0);
    let evos=[hasNucleus?'üß¨':'',hasMitochondria?'‚ö°':'',hasChloroplasts?'üåø':''].filter(Boolean).join(' ');
    deathMsg.innerText=`Eaten by ${killer}! Mass: ${Math.floor(fm)}${evos?' | Evolved: '+evos:''}`;
    deathScreen.style.display='flex';
}
function playerWon(totalMass){
    gameActive=false;
    let elapsed=Date.now()-gameStartTime;
    let mins=Math.floor(elapsed/60000), secs=Math.floor((elapsed%60000)/1000);
    document.getElementById('v-mass').innerText=Math.floor(totalMass).toLocaleString();
    document.getElementById('v-time').innerText=`${mins}:${secs.toString().padStart(2,'0')}`;
    document.getElementById('v-bots').innerText=botsEaten;
    victoryScreen.style.display='flex';
}
 
// ‚îÄ‚îÄ Bot AI ‚îÄ‚îÄ
function getBotBehavior(b,nearestP,distP,nearestSB,distSB,elapsed,shieldOn){
    let moveX=0,moveY=0;
    if(elapsed<PHASE1_END){
        if(!shieldOn&&nearestP&&distP<150&&b.mass>nearestP.mass*1.15){let a=Math.atan2(nearestP.y-b.y,nearestP.x-b.x);moveX=Math.cos(a);moveY=Math.sin(a);}
        else if(!shieldOn&&nearestP&&distP<150&&nearestP.mass>b.mass*1.15){let a=Math.atan2(nearestP.y-b.y,nearestP.x-b.x);moveX=-Math.cos(a);moveY=-Math.sin(a);}
        else {
            // Head toward nearest black virus food zone OR nearest food
            let target=null,bestD=9999;
            for(let bv of blackViruses){let d=Math.hypot(b.x-bv.x,b.y-bv.y);if(d<300&&d<bestD){bestD=d;target={x:bv.x+(Math.random()-.5)*100,y:bv.y+(Math.random()-.5)*100};}}
            if(!target){for(let f of food){let d=Math.hypot(b.x-f.x,b.y-f.y);if(d<bestD){bestD=d;target=f;}}}
            if(target){let a=Math.atan2(target.y-b.y,target.x-b.x);moveX=Math.cos(a);moveY=Math.sin(a);}
            else{if(Math.random()<0.02){b.wandX=Math.random()-.5;b.wandY=Math.random()-.5;}moveX=b.wandX;moveY=b.wandY;}
        }
    } else if(elapsed<PHASE2_END){
        if(!shieldOn&&nearestP&&distP<150&&b.mass>nearestP.mass*1.15){let a=Math.atan2(nearestP.y-b.y,nearestP.x-b.x);moveX=Math.cos(a);moveY=Math.sin(a);}
        else if(!shieldOn&&nearestP&&distP<150&&nearestP.mass>b.mass*1.15){let a=Math.atan2(nearestP.y-b.y,nearestP.x-b.x);moveX=-Math.cos(a);moveY=-Math.sin(a);}
        else if(nearestSB&&distSB<600){let a=Math.atan2(nearestSB.y-b.y,nearestSB.x-b.x);moveX=Math.cos(a);moveY=Math.sin(a);}
        else {
            let bestFood=null,bestFoodDist=400;
            for(let bv of blackViruses){let d=Math.hypot(b.x-bv.x,b.y-bv.y);if(d<250&&d<bestFoodDist){bestFoodDist=d;bestFood={x:bv.x+(Math.random()-.5)*80,y:bv.y+(Math.random()-.5)*80};}}
            if(!bestFood){for(let f of food){let d=Math.hypot(b.x-f.x,b.y-f.y);if(d<400&&d<bestFoodDist){bestFoodDist=d;bestFood=f;}}}
            if(bestFood){let a=Math.atan2(bestFood.y-b.y,bestFood.x-b.x);moveX=Math.cos(a);moveY=Math.sin(a);}
            else{if(Math.random()<0.02){b.wandX=Math.random()-.5;b.wandY=Math.random()-.5;}moveX=b.wandX;moveY=b.wandY;}
        }
    } else {
        if(!shieldOn&&nearestP&&distP<900&&b.mass>nearestP.mass*1.15){
            let a=Math.atan2(nearestP.y-b.y,nearestP.x-b.x);moveX=Math.cos(a);moveY=Math.sin(a);
            if(b.aggro&&b.mass>nearestP.mass*2.2&&distP<400&&distP>150&&Date.now()-b.splitTime>10000&&bots.length<MAX_BOTS){
                b.mass/=2;b.r=Math.sqrt(b.mass)*CELL_SCALE;b.splitTime=Date.now();spawnBot(b,moveX*35,moveY*35);
            }
        } else if(!shieldOn&&nearestP&&distP<700&&nearestP.mass>b.mass*1.15){let a=Math.atan2(nearestP.y-b.y,nearestP.x-b.x);moveX=-Math.cos(a);moveY=-Math.sin(a);}
        else if(nearestSB&&distSB<700){
            let a=Math.atan2(nearestSB.y-b.y,nearestSB.x-b.x);moveX=Math.cos(a);moveY=Math.sin(a);
            if(b.mass>nearestSB.mass*2.5&&distSB<350&&Date.now()-b.splitTime>10000&&bots.length<MAX_BOTS){
                b.mass/=2;b.r=Math.sqrt(b.mass)*CELL_SCALE;b.splitTime=Date.now();spawnBot(b,moveX*35,moveY*35);
            }
        } else {
            let bestFood=null,bestFoodDist=9999;
            for(let bv of blackViruses){let d=Math.hypot(b.x-bv.x,b.y-bv.y);if(d<350&&d<bestFoodDist){bestFoodDist=d;bestFood={x:bv.x+(Math.random()-.5)*100,y:bv.y+(Math.random()-.5)*100};}}
            if(!bestFood){for(let f of food){let d=Math.hypot(b.x-f.x,b.y-f.y);if(d<bestFoodDist){bestFoodDist=d;bestFood=f;}}}
            if(bestFood){let a=Math.atan2(bestFood.y-b.y,bestFood.x-b.x);moveX=Math.cos(a);moveY=Math.sin(a);}
            else{if(Math.random()<0.02){b.wandX=Math.random()-.5;b.wandY=Math.random()-.5;}moveX=b.wandX;moveY=b.wandY;}
        }
    }
    return {moveX,moveY};
}
 
// ‚îÄ‚îÄ Update ‚îÄ‚îÄ
function update(){
    if(!gameActive) return;
    const now=Date.now(), elapsed=now-gameStartTime;
    if(metabolicBoost>0) metabolicBoost--;
 
    const shieldOn=now<shieldEndTime;
    if(shieldOn){shieldBarEl.style.display='block';shieldValEl.innerText=Math.ceil((shieldEndTime-now)/1000);}
    else shieldBarEl.style.display='none';
 
    processBotRespawns(now);
 
    // Direction
    let kX=0,kY=0;
    if(isTouchDevice&&(touchJoyX||touchJoyY)){kX=touchJoyX;kY=touchJoyY;}
    else{
        if(keys['KeyW']||keys['ArrowUp'])   kY=-1;
        if(keys['KeyS']||keys['ArrowDown']) kY=1;
        if(keys['KeyA']||keys['ArrowLeft']) kX=-1;
        if(keys['KeyD']||keys['ArrowRight'])kX=1;
        if(kX||kY){let m=Math.hypot(kX,kY);kX/=m;kY/=m;}
        else if(mouseX!==null){
            let wx=(mouseX-width/2)/cameraZoom+avgX,wy=(mouseY-height/2)/cameraZoom+avgY;
            let dx=wx-avgX,dy=wy-avgY,dist=Math.hypot(dx,dy);
            if(dist>5){kX=dx/dist;kY=dy/dist;}
        }
    }
    joyX=kX;joyY=kY;
 
    let totalMass=playerCells.reduce((s,c)=>s+c.mass,0);
    if(totalMass>peakMass) peakMass=totalMass;
    isSprinting=keys['Space']&&now>sprintCooldownTimer;
    if(isSprinting&&sprintBaselineMass!==null&&totalMass<sprintBaselineMass*0.9){sprintCooldownTimer=now+30000;sprintBaselineMass=null;keys['Space']=false;isSprinting=false;}
    if(now<sprintCooldownTimer){sprintStatusEl.style.display='block';sprintStatusEl.className='score-box exhausted';sprintStatusEl.innerText=`EXHAUSTED: ${Math.ceil((sprintCooldownTimer-now)/1000)}s`;}
    else if(isSprinting&&sprintBaselineMass){sprintStatusEl.style.display='block';sprintStatusEl.className='score-box';sprintStatusEl.innerText=`SPRINT: ${(totalMass/sprintBaselineMass*100).toFixed(1)}%`;}
    else sprintStatusEl.style.display='none';
 
    checkEvolution(totalMass);
 
    // Win check
    if(totalMass>=WIN_MASS){playerWon(totalMass);return;}
 
    const foodVal=hasChloroplasts?3:1.5;
    const mitoSpeedBonus=hasMitochondria?0.6:0;
 
    // Particles
    for(let i=particles.length-1;i>=0;i--){let p=particles[i];p.x+=p.vx;p.y+=p.vy;p.life-=0.03;if(p.life<=0)particles.splice(i,1);}
 
    // ‚îÄ‚îÄ Black Viruses: spew food rapidly ‚îÄ‚îÄ
    for(let bv of blackViruses){
        bv.pulseT+=0.06;
        bv.spewTimer++;
        if(bv.spewTimer>=4){ // every 4 frames = ~15 food/sec
            bv.spewTimer=0;
            if(food.length<900) spawnFood(bv.x,bv.y);
        }
    }
 
    // ‚îÄ‚îÄ Red Viruses: drift + bounce ‚îÄ‚îÄ
    for(let rv of redViruses){
        rv.pulseT+=0.05;
        rv.x+=rv.vx; rv.y+=rv.vy;
        if(rv.x<rv.r||rv.x>WORLD_SIZE-rv.r) rv.vx*=-1;
        if(rv.y<rv.r||rv.y>WORLD_SIZE-rv.r) rv.vy*=-1;
        rv.x=Math.max(rv.r,Math.min(WORLD_SIZE-rv.r,rv.x));
        rv.y=Math.max(rv.r,Math.min(WORLD_SIZE-rv.r,rv.y));
    }
 
    buildGrid(food);
 
    // ‚îÄ‚îÄ Player Cells ‚îÄ‚îÄ
    for(let i=0;i<playerCells.length;i++){
        let c1=playerCells[i];
        let speed=(4.8*(1.1-(c1.r/800))+mitoSpeedBonus)*((metabolicBoost>0)?1.5:1)*(isSprinting?1.8:1);
        c1.x+=joyX*speed+c1.vx; c1.y+=joyY*speed+c1.vy;
        c1.vx*=0.9; c1.vy*=0.9;
        c1.x=Math.max(c1.r,Math.min(WORLD_SIZE-c1.r,c1.x));
        c1.y=Math.max(c1.r,Math.min(WORLD_SIZE-c1.r,c1.y));
 
        if(isSprinting&&c1.mass>20&&(joyX||joyY)){
            c1.mass-=0.05; c1.r=Math.sqrt(c1.mass)*CELL_SCALE;
            if(Math.random()<0.3) particles.push({x:c1.x-joyX*c1.r,y:c1.y-joyY*c1.r,vx:-joyX*2+(Math.random()-.5)*2,vy:-joyY*2+(Math.random()-.5)*2,life:1});
        }
 
        // Merge
        for(let j=i+1;j<playerCells.length;j++){
            let c2=playerCells[j];
            if(Math.hypot(c1.x-c2.x,c1.y-c2.y)<(c1.r+c2.r)*0.9&&now-c1.splitTime>MERGE_COOLDOWN&&now-c2.splitTime>MERGE_COOLDOWN){
                c1.mass+=c2.mass; c1.r=Math.sqrt(c1.mass)*CELL_SCALE; playerCells.splice(j,1); j--;
            }
        }
 
        // Eat food
        let nearby=getNearby(c1.x,c1.y,c1.r);
        for(let f of nearby){let fi=food.indexOf(f);if(fi===-1)continue;if(Math.hypot(c1.x-f.x,c1.y-f.y)<c1.r){c1.mass+=foodVal;c1.r=Math.sqrt(c1.mass)*CELL_SCALE;food.splice(fi,1);spawnFood();}}
 
        // Eat ATP
        for(let a=atp.length-1;a>=0;a--){if(Math.hypot(c1.x-atp[a].x,c1.y-atp[a].y)<c1.r){metabolicBoost=300;atp.splice(a,1);setTimeout(()=>atp.push({x:Math.random()*WORLD_SIZE,y:Math.random()*WORLD_SIZE,r:10}),5000);}}
 
        // Green virus bursts player
        for(let v=viruses.length-1;v>=0;v--){
            if(Math.hypot(c1.x-viruses[v].x,c1.y-viruses[v].y)<c1.r&&c1.mass>130){
                burstCell(c1,playerCells); viruses.splice(v,1);
                setTimeout(()=>viruses.push({x:Math.random()*WORLD_SIZE,y:Math.random()*WORLD_SIZE,r:60}),10000); break;
            }
        }
 
        // Black virus ‚Äî hard wall block; eat at 20000+
        for(let bv of blackViruses){
            let dist=Math.hypot(c1.x-bv.x,c1.y-bv.y);
            let minDist=c1.r+bv.r;
            if(dist<minDist){
                if(c1.mass>=20000){
                    c1.mass+=500; c1.r=Math.sqrt(c1.mass)*CELL_SCALE;
                    blackViruses.splice(blackViruses.indexOf(bv),1);
                    break;
                }
                // Push player out ‚Äî hard wall
                let ang=Math.atan2(c1.y-bv.y,c1.x-bv.x);
                c1.x=bv.x+Math.cos(ang)*(minDist+1);
                c1.y=bv.y+Math.sin(ang)*(minDist+1);
                // Kill velocity toward virus
                let dot=c1.vx*Math.cos(ang)+c1.vy*Math.sin(ang);
                if(dot<0){c1.vx-=dot*Math.cos(ang);c1.vy-=dot*Math.sin(ang);}
            }
        }
 
        // Red virus ‚Äî -20% mass on touch; eat at 10000+
        for(let ri=redViruses.length-1;ri>=0;ri--){
            let rv=redViruses[ri];
            if(Math.hypot(c1.x-rv.x,c1.y-rv.y)<c1.r+rv.r){
                if(c1.mass>=10000){
                    c1.mass+=200; c1.r=Math.sqrt(c1.mass)*CELL_SCALE;
                    redViruses.splice(ri,1); spawnRedVirus(); break;
                }
                // Drain 20% ‚Äî once per contact (use cooldown on cell)
                if(!c1.redCooldown||now>c1.redCooldown){
                    c1.mass=Math.max(10,c1.mass*0.8);
                    c1.r=Math.sqrt(c1.mass)*CELL_SCALE;
                    c1.redCooldown=now+1200;
                    // Particle burst
                    for(let p=0;p<8;p++) particles.push({x:c1.x,y:c1.y,vx:(Math.random()-.5)*6,vy:(Math.random()-.5)*6,life:1});
                }
            }
        }
    }
 
    // ‚îÄ‚îÄ Green Viruses burst bots ‚îÄ‚îÄ
    for(let vi=viruses.length-1;vi>=0;vi--){
        let v=viruses[vi];
        for(let bi=bots.length-1;bi>=0;bi--){
            let b=bots[bi]; if(!b)continue;
            if(b.mass>130&&Math.hypot(b.x-v.x,b.y-v.y)<b.r+v.r){
                let pieces=6,sm=b.mass/pieces;
                if(sm>=8){b.mass=sm;b.r=Math.sqrt(sm)*CELL_SCALE;b.splitTime=now;
                    let canSpawn=Math.min(pieces-1,MAX_BOTS-bots.length);
                    for(let i=1;i<=canSpawn;i++){let a=(Math.PI*2/pieces)*i;spawnBot(b,Math.cos(a)*18,Math.sin(a)*18);}
                }
                viruses.splice(vi,1);
                setTimeout(()=>viruses.push({x:Math.random()*WORLD_SIZE,y:Math.random()*WORLD_SIZE,r:60}),10000);
                break;
            }
        }
    }
 
    // ‚îÄ‚îÄ Red viruses hit bots ‚îÄ‚îÄ
    for(let rv of redViruses){
        for(let bi=bots.length-1;bi>=0;bi--){
            let b=bots[bi]; if(!b)continue;
            if(Math.hypot(b.x-rv.x,b.y-rv.y)<b.r+rv.r){
                if(b.mass>=10000){
                    // Bot eats red virus
                    b.mass+=200; b.r=Math.sqrt(b.mass)*CELL_SCALE;
                    let idx=redViruses.indexOf(rv); if(idx>-1){redViruses.splice(idx,1);spawnRedVirus();}
                    break;
                }
                if(!b.redCooldown||now>b.redCooldown){
                    b.mass=Math.max(10,b.mass*0.8); b.r=Math.sqrt(b.mass)*CELL_SCALE; b.redCooldown=now+1200;
                }
            }
        }
    }
 
    // ‚îÄ‚îÄ Bot AI ‚îÄ‚îÄ
    for(let bi=bots.length-1;bi>=0;bi--){
        let b=bots[bi]; if(!b)continue;
        let speed=4.0*(1.1-(b.r/800));
        let nearestP=null,distP=9999;
        for(let pc of playerCells){let d=Math.hypot(b.x-pc.x,b.y-pc.y);if(d<distP){distP=d;nearestP=pc;}}
        let nearestSB=null,distSB=9999;
        for(let bi2=0;bi2<bots.length;bi2++){
            if(bi2===bi)continue; let b2=bots[bi2];if(!b2)continue;
            if(b.mass>b2.mass*1.2){let d=Math.hypot(b.x-b2.x,b.y-b2.y);if(d<distSB){distSB=d;nearestSB=b2;}}
        }
 
        // Bots eat black virus at 20000+
        for(let bv of blackViruses){
            if(b.mass>=20000&&Math.hypot(b.x-bv.x,b.y-bv.y)<b.r+bv.r){
                b.mass+=500;b.r=Math.sqrt(b.mass)*CELL_SCALE;
                blackViruses.splice(blackViruses.indexOf(bv),1); break;
            }
        }
 
        let {moveX,moveY}=getBotBehavior(b,nearestP,distP,nearestSB,distSB,elapsed,shieldOn);
 
        // ‚îÄ‚îÄ Black virus avoidance: wide-arc steering ‚îÄ‚îÄ
        // If bot is heading toward a black virus it can't eat, steer around it
        if(b.mass<20000){
            for(let bv of blackViruses){
                let dx=bv.x-b.x, dy=bv.y-b.y;
                let dist=Math.hypot(dx,dy);
                let avoidRadius=bv.r+b.r+60; // wide arc margin
                if(dist<avoidRadius && dist>0){
                    // Perpendicular deflection ‚Äî push move vector sideways
                    let nx=dx/dist, ny=dy/dist;
                    let dot=moveX*nx+moveY*ny;
                    if(dot>0){ // only deflect if actually heading toward it
                        let strength=1-(dist/avoidRadius);
                        // Pick the perpendicular direction that costs less (cross product sign)
                        let cross=moveX*ny-moveY*nx;
                        let perpX= cross>=0?-ny:ny;
                        let perpY= cross>=0? nx:-nx;
                        moveX=moveX*(1-strength)+perpX*strength;
                        moveY=moveY*(1-strength)+perpY*strength;
                        let m=Math.hypot(moveX,moveY);
                        if(m>0){moveX/=m;moveY/=m;}
                    }
                }
            }
        }
 
        b.x+=moveX*speed+b.vx; b.y+=moveY*speed+b.vy;
        b.vx*=0.9; b.vy*=0.9;
        b.x=Math.max(b.r,Math.min(WORLD_SIZE-b.r,b.x));
        b.y=Math.max(b.r,Math.min(WORLD_SIZE-b.r,b.y));
 
        // ‚îÄ‚îÄ Black virus hard wall for bots ‚îÄ‚îÄ
        for(let bv of blackViruses){
            let dist=Math.hypot(b.x-bv.x,b.y-bv.y);
            let minDist=b.r+bv.r;
            if(dist<minDist&&b.mass<20000){
                let ang=Math.atan2(b.y-bv.y,b.x-bv.x);
                b.x=bv.x+Math.cos(ang)*(minDist+1);
                b.y=bv.y+Math.sin(ang)*(minDist+1);
                let dot=b.vx*Math.cos(ang)+b.vy*Math.sin(ang);
                if(dot<0){b.vx-=dot*Math.cos(ang);b.vy-=dot*Math.sin(ang);}
            }
        }
 
        // Bot eats food
        for(let f=food.length-1;f>=0;f--){if(Math.hypot(b.x-food[f].x,b.y-food[f].y)<b.r){b.mass+=1.5;b.r=Math.sqrt(b.mass)*CELL_SCALE;food.splice(f,1);spawnFood();}}
 
        // Bot eats smaller bot
        for(let bi2=bots.length-1;bi2>=0;bi2‚Äì){
            if(bi2===bi)continue; let b2=bots[bi2];if(!b2)continue;
            if(b.mass>b2.mass*1.15&&Math.hypot(b.x-b2.x,b.y-b2.y)<b.r*0.85){
                b.mass+=b2.mass*0.5;b.r=Math.sqrt(b.mass)*CELL_SCALE;
                bots.splice(bi2,1);if(bi2<bi)bi--;queueBotRespawn();break;
            }
        }
        if(!bots[bi])continue;
 
        // Bot eats player
        if(!shieldOn){
            for(let pi=playerCells.length-1;pi>=0;pi--){
                let pc=playerCells[pi];
                if(bots[bi]&&b.mass>pc.mass*1.15&&Math.hypot(b.x-pc.x,b.y-pc.y)<b.r*0.85){
                    b.mass+=pc.mass*0.5;b.r=Math.sqrt(b.mass)*CELL_SCALE;
                    playerCells.splice(pi,1);
                    if(playerCells.length===0){playerDied(b.name);return;}
                }
            }
        }
        if(!bots[bi])continue;
 
        // Player eats bot
        for(let pi=0;pi<playerCells.length;pi++){
            let pc=playerCells[pi];
            if(pc.mass>b.mass*1.15&&Math.hypot(pc.x-b.x,pc.y-b.y)<pc.r*0.85){
                pc.mass+=b.mass;pc.r=Math.sqrt(pc.mass)*CELL_SCALE;
                showEatPopup({full:bots[bi].full, quote:bots[bi].quote});
                botsEaten++;
                bots.splice(bi,1);queueBotRespawn();break;
            }
        }
    }
 
    totalMass=playerCells.reduce((s,c)=>s+c.mass,0);
    if(totalMass>peakMass) peakMass=totalMass;
    cameraZoom+=(Math.max(0.18,1-(totalMass/15000))-cameraZoom)*0.05;
    scoreEl.innerText=Math.floor(totalMass);
    mobileScoreEl.innerText=Math.floor(totalMass);
 
    // Leaderboard
    if(now-lastLBUpdate>500){
        lastLBUpdate=now;
        let list=bots.map(b=>({name:b.name,mass:b.mass}));
        list.push({name:'YOU',mass:totalMass,me:true});
        list.sort((a,b)=>b.mass-a.mass);
        let respawnInfo='';
        if(botRespawnQueue.length>0){let nextIn=Math.ceil((Math.min(...botRespawnQueue)-now)/1000);respawnInfo=`<div style="color:#ff9800;margin-top:6px;font-size:11px">‚è≥ ${botRespawnQueue.length} respawning in ${Math.max(0,nextIn)}s</div>`;}
        lbList.innerHTML=list.slice(0,5).map(e=>`<div style="display:flex;justify-content:space-between;gap:10px;${e.me?'color:#00e5ff':''}"><span>${e.me?'üëë YOU':e.name}</span><span>${Math.floor(e.mass)}</span></div>`).join('')
            +`<div style="color:#78909c;margin-top:6px;font-size:11px">Bots: ${bots.length}/${MAX_BOTS}</div>`
            +respawnInfo;
    }
}
 
// ‚îÄ‚îÄ Organelle Drawers ‚îÄ‚îÄ
function drawNucleus(cx,cy,r){
    let nr=r*0.36;
    ctx.fillStyle='rgba(100,0,160,0.5)';ctx.beginPath();ctx.arc(cx,cy,nr,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='rgba(220,130,255,0.75)';ctx.lineWidth=2;ctx.stroke();
    ctx.fillStyle='rgba(220,130,255,0.6)';ctx.beginPath();ctx.arc(cx,cy,nr*0.35,0,Math.PI*2);ctx.fill();
}
function drawMitochondria(cx,cy,r){
    let count=3,t=Date.now()/3000;
    for(let i=0;i<count;i++){
        let angle=(Math.PI*2/count)*i+t,ox=cx+Math.cos(angle)*r*0.52,oy=cy+Math.sin(angle)*r*0.52;
        ctx.save();ctx.translate(ox,oy);ctx.rotate(angle+Math.PI/2);
        ctx.fillStyle='rgba(255,190,0,0.8)';ctx.beginPath();ctx.ellipse(0,0,r*0.07,r*0.15,0,0,Math.PI*2);ctx.fill();
        ctx.strokeStyle='rgba(255,120,0,0.6)';ctx.lineWidth=1.5;ctx.stroke();ctx.restore();
    }
}
function drawChloroplasts(cx,cy,r){
    let count=4,t=Date.now()/4000;
    for(let i=0;i<count;i++){
        let angle=(Math.PI*2/count)*i-t,ox=cx+Math.cos(angle)*r*0.5,oy=cy+Math.sin(angle)*r*0.5;
        ctx.save();ctx.translate(ox,oy);ctx.rotate(angle+Math.PI/2);
        ctx.fillStyle='rgba(50,190,60,0.85)';ctx.beginPath();ctx.ellipse(0,0,r*0.07,r*0.14,0,0,Math.PI*2);ctx.fill();
        ctx.strokeStyle='rgba(0,120,0,0.5)';ctx.lineWidth=1;ctx.stroke();ctx.restore();
    }
}
// ‚îÄ‚îÄ Stylized Bot Cell Drawings ‚îÄ‚îÄ
function drawBot(b){
    const t=Date.now()/1000;
    const x=b.x, y=b.y, r=b.r, c=b.c;
    ctx.save();
 
    switch(b.name){
        case 'Amy': { // Amoeba ‚Äî irregular blob with pseudopods
            let arms=5;
            ctx.fillStyle=c;
            ctx.beginPath();
            for(let i=0;i<arms*2;i++){
                let ang=(Math.PI*2/(arms*2))*i+t*0.4;
                let rr=i%2===0?r*(0.9+0.18*Math.sin(t*1.1+i)):r*0.6;
                i===0?ctx.moveTo(x+Math.cos(ang)*rr,y+Math.sin(ang)*rr):ctx.lineTo(x+Math.cos(ang)*rr,y+Math.sin(ang)*rr);
            }
            ctx.closePath(); ctx.fill();
            // nucleus dot
            ctx.fillStyle='rgba(255,255,255,0.4)'; ctx.beginPath(); ctx.arc(x+r*0.2,y-r*0.1,r*0.28,0,Math.PI*2); ctx.fill();
            break;
        }
        case 'Genie': { // Euglena ‚Äî elongated oval + single flagellum
            ctx.translate(x,y); ctx.rotate(t*0.5);
            ctx.fillStyle=c;
            ctx.beginPath(); ctx.ellipse(0,0,r*0.45,r,0,0,Math.PI*2); ctx.fill();
            // eyespot
            ctx.fillStyle='#e53935'; ctx.beginPath(); ctx.arc(-r*0.1,-r*0.55,r*0.15,0,Math.PI*2); ctx.fill();
            // flagellum ‚Äî wavy line
            ctx.strokeStyle='rgba(255,255,255,0.7)'; ctx.lineWidth=Math.max(1.5,r*0.06);
            ctx.beginPath(); ctx.moveTo(0,-r);
            for(let i=0;i<=8;i++){let tt=i/8;ctx.lineTo(Math.sin(tt*Math.PI*3+t*4)*r*0.25,-(r+tt*r*0.9));}
            ctx.stroke();
            break;
        }
        case 'Para': { // Paramecium ‚Äî oval with cilia fringe
            ctx.translate(x,y); ctx.rotate(Math.sin(t*0.3)*0.3);
            ctx.fillStyle=c;
            ctx.beginPath(); ctx.ellipse(0,0,r*0.55,r,0,0,Math.PI*2); ctx.fill();
            // oral groove
            ctx.strokeStyle='rgba(0,0,0,0.3)'; ctx.lineWidth=r*0.08;
            ctx.beginPath(); ctx.moveTo(-r*0.1,-r*0.4); ctx.quadraticCurveTo(r*0.35,0,-r*0.1,r*0.4); ctx.stroke();
            // cilia
            ctx.strokeStyle='rgba(255,255,255,0.6)'; ctx.lineWidth=Math.max(1,r*0.04);
            let ciliaCount=14;
            for(let i=0;i<ciliaCount;i++){
                let ang=(Math.PI*2/ciliaCount)*i, wave=Math.sin(t*5+i)*0.25;
                let bx=Math.cos(ang)*r*0.55, by=Math.sin(ang)*r;
                ctx.beginPath(); ctx.moveTo(bx,by);
                ctx.lineTo(bx*(1+0.35+wave),by*(1+0.35+wave)); ctx.stroke();
            }
            break;
        }
        case 'Volvie': { // Volvox ‚Äî sphere of tiny sub-cells
            ctx.fillStyle=c+'99';
            ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle=c; ctx.lineWidth=2; ctx.stroke();
            let nc=8;
            for(let i=0;i<nc;i++){
                let ang=(Math.PI*2/nc)*i+t*0.2, ox=x+Math.cos(ang)*r*0.68, oy=y+Math.sin(ang)*r*0.68;
                ctx.fillStyle=c; ctx.beginPath(); ctx.arc(ox,oy,r*0.18,0,Math.PI*2); ctx.fill();
                ctx.strokeStyle='rgba(255,255,255,0.5)'; ctx.lineWidth=1; ctx.stroke();
            }
            // inner daughter colony
            ctx.fillStyle=c+'66'; ctx.beginPath(); ctx.arc(x,y,r*0.35,0,Math.PI*2); ctx.fill();
            break;
        }
        case 'Dino': { // Dinoflagellate ‚Äî round with two perpendicular grooves + glow
            ctx.fillStyle=c;
            ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
            // cingulum (horizontal groove)
            ctx.strokeStyle='rgba(0,0,0,0.4)'; ctx.lineWidth=r*0.12;
            ctx.beginPath(); ctx.ellipse(x,y,r,r*0.15,0,0,Math.PI*2); ctx.stroke();
            // sulcus (vertical groove)
            ctx.beginPath(); ctx.moveTo(x,y-r); ctx.lineTo(x,y+r); ctx.stroke();
            // bioluminescent glow
            let glow=ctx.createRadialGradient(x,y,r*0.3,x,y,r*1.5);
            glow.addColorStop(0,`rgba(0,220,180,${0.15+0.1*Math.sin(t*2)})`);
            glow.addColorStop(1,'rgba(0,0,0,0)');
            ctx.fillStyle=glow; ctx.beginPath(); ctx.arc(x,y,r*1.5,0,Math.PI*2); ctx.fill();
            break;
        }
        case 'Stylo': { // Stylonychia ‚Äî rectangular with cirri legs
            ctx.translate(x,y); ctx.rotate(t*0.3);
            ctx.fillStyle=c;
            ctx.beginPath(); ctx.roundRect(-r*0.5,-r,r,r*2,r*0.3); ctx.fill();
            // cirri (stiff leg-like cilia)
            ctx.strokeStyle='rgba(255,255,255,0.75)'; ctx.lineWidth=Math.max(1.5,r*0.06);
            for(let i=0;i<6;i++){
                let lx=(i%2===0?-r*0.5:r*0.5), ly=-r*0.7+i*r*0.28;
                let kick=Math.sin(t*6+i*1.2)*r*0.3;
                ctx.beginPath(); ctx.moveTo(lx,ly); ctx.lineTo(lx+(i%2===0?-kick:kick),ly+r*0.4); ctx.stroke();
            }
            break;
        }
        case 'Bleppy': { // Blepharisma ‚Äî pink elongated with visible macronucleus
            ctx.translate(x,y); ctx.rotate(Math.sin(t*0.5)*0.2);
            ctx.fillStyle='#f48fb1';
            ctx.beginPath(); ctx.ellipse(0,0,r*0.5,r,0,0,Math.PI*2); ctx.fill();
            // macronucleus chain (beaded)
            ctx.fillStyle='rgba(180,0,80,0.6)';
            for(let i=-1;i<=1;i++){ctx.beginPath();ctx.arc(0,i*r*0.38,r*0.2,0,Math.PI*2);ctx.fill();}
            // cilia fringe
            ctx.strokeStyle='rgba(255,200,220,0.7)'; ctx.lineWidth=Math.max(1,r*0.04);
            for(let i=0;i<12;i++){let ang=(Math.PI*2/12)*i,wave=Math.sin(t*5+i)*0.2;ctx.beginPath();ctx.moveTo(Math.cos(ang)*r*0.5,Math.sin(ang)*r);ctx.lineTo(Math.cos(ang)*r*(0.5+0.3+wave),Math.sin(ang)*r*(1+0.3+wave));ctx.stroke();}
            break;
        }
        case 'Oxi': { // Oxytricha ‚Äî flattened oval, lots of cirri
            ctx.translate(x,y);
            ctx.fillStyle=c;
            ctx.beginPath(); ctx.ellipse(0,0,r,r*0.6,0,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle='rgba(255,255,255,0.6)'; ctx.lineWidth=Math.max(1,r*0.05);
            for(let i=0;i<10;i++){
                let bx=-r+i*(r*0.22), phase=Math.sin(t*7+i)*r*0.25;
                ctx.beginPath(); ctx.moveTo(bx,r*0.6); ctx.lineTo(bx+phase,r*1.1); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(bx,-r*0.6); ctx.lineTo(bx-phase,-r*1.1); ctx.stroke();
            }
            break;
        }
        case 'Vorty': { // Vorticella ‚Äî bell on a stalk
            ctx.translate(x,y);
            let stalkLen=r*0.9, coil=Math.sin(t*3)*0.4;
            // stalk (coiled spring)
            ctx.strokeStyle='rgba(255,255,255,0.6)'; ctx.lineWidth=Math.max(1.5,r*0.07);
            ctx.beginPath(); ctx.moveTo(0,0);
            for(let i=0;i<=10;i++){let tt=i/10;ctx.lineTo(Math.sin(tt*Math.PI*4+t*3)*r*0.15,stalkLen*tt);}
            ctx.stroke();
            // bell body
            ctx.fillStyle=c;
            ctx.beginPath(); ctx.ellipse(0,-r*0.55,r*0.7,r*0.55,0,0,Math.PI*2); ctx.fill();
            // oral cilia crown
            ctx.strokeStyle='rgba(255,255,255,0.7)'; ctx.lineWidth=Math.max(1,r*0.05);
            for(let i=0;i<10;i++){let ang=(Math.PI*2/10)*i+t*2;ctx.beginPath();ctx.moveTo(Math.cos(ang)*r*0.65,-r*0.1);ctx.lineTo(Math.cos(ang)*r*0.85+Math.cos(ang+0.5)*r*0.2,-r*0.1+Math.sin(ang+t)*r*0.22);ctx.stroke();}
            break;
        }
        case 'Spiro': { // Spirostomum ‚Äî very long, narrow worm-like
            ctx.translate(x,y); ctx.rotate(t*0.2);
            ctx.fillStyle=c;
            ctx.beginPath(); ctx.ellipse(0,0,r*0.28,r,0,0,Math.PI*2); ctx.fill();
            // contraction ripple rings
            ctx.strokeStyle='rgba(255,255,255,0.3)'; ctx.lineWidth=1;
            for(let i=-3;i<=3;i++){ctx.beginPath();ctx.ellipse(0,i*r*0.28,r*0.28,r*0.06,0,0,Math.PI*2);ctx.stroke();}
            break;
        }
        case 'Noctie': { // Noctiluca ‚Äî round with a big tentacle + glow
            ctx.fillStyle=c+'cc';
            ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
            // bioluminescent shimmer
            let ng=ctx.createRadialGradient(x,y,0,x,y,r);
            ng.addColorStop(0,`rgba(100,220,255,${0.3+0.2*Math.sin(t*1.5)})`);
            ng.addColorStop(1,'rgba(0,100,200,0)');
            ctx.fillStyle=ng; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
            // single long tentacle
            ctx.strokeStyle='rgba(200,240,255,0.8)'; ctx.lineWidth=Math.max(2,r*0.08);
            ctx.beginPath(); ctx.moveTo(x,y);
            let ta=t*0.8, tx=x+Math.cos(ta)*r*1.6, ty=y+Math.sin(ta)*r*1.6;
            ctx.quadraticCurveTo(x+Math.cos(ta+0.8)*r,y+Math.sin(ta+0.8)*r,tx,ty); ctx.stroke();
            break;
        }
        case 'Diddy': { // Didinium ‚Äî barrel-shaped with two ciliary bands
            ctx.translate(x,y);
            ctx.fillStyle=c;
            ctx.beginPath(); ctx.ellipse(0,0,r*0.75,r*0.75,0,0,Math.PI*2); ctx.fill();
            // proboscis (cone top)
            ctx.fillStyle=c;
            ctx.beginPath(); ctx.moveTo(0,-r*0.75); ctx.lineTo(-r*0.25,-r*1.2); ctx.lineTo(r*0.25,-r*1.2); ctx.closePath(); ctx.fill();
            // two ciliary rings
            ctx.strokeStyle='rgba(255,255,255,0.6)'; ctx.lineWidth=Math.max(2,r*0.08);
            for(let band of [-0.3,0.3]){ctx.beginPath();ctx.ellipse(0,r*band,r*0.75,r*0.12,0,0,Math.PI*2);ctx.stroke();}
            break;
        }
        case 'Chaos': { // Chaos/Difflugia ‚Äî shell + many pseudopods
            ctx.fillStyle='#8d6e63';
            ctx.beginPath(); ctx.arc(x,y,r*0.75,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle='#5d4037'; ctx.lineWidth=3; ctx.stroke();
            // many pseudopods oozing out
            ctx.fillStyle=c;
            let np=7;
            for(let i=0;i<np;i++){
                let ang=(Math.PI*2/np)*i+t*0.3, len=r*(0.6+0.3*Math.sin(t*1.5+i));
                let px=x+Math.cos(ang)*len, py=y+Math.sin(ang)*len;
                ctx.beginPath(); ctx.arc(px,py,r*0.22,0,Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.moveTo(x+Math.cos(ang)*r*0.4,y+Math.sin(ang)*r*0.4);
                ctx.lineTo(px,py); ctx.lineWidth=r*0.18; ctx.strokeStyle=c; ctx.stroke();
            }
            break;
        }
        case 'Tetra': { // Tetrahymena ‚Äî pear-shaped with oral apparatus
            ctx.translate(x,y); ctx.rotate(Math.sin(t*0.4)*0.2);
            ctx.fillStyle=c;
            ctx.beginPath(); ctx.moveTo(0,-r); ctx.bezierCurveTo(r*0.8,-r*0.5,r*0.7,r*0.5,0,r); ctx.bezierCurveTo(-r*0.7,r*0.5,-r*0.8,-r*0.5,0,-r); ctx.fill();
            // oral groove
            ctx.strokeStyle='rgba(255,255,255,0.5)'; ctx.lineWidth=r*0.1;
            ctx.beginPath(); ctx.moveTo(-r*0.1,-r*0.6); ctx.quadraticCurveTo(r*0.4,0,0,r*0.6); ctx.stroke();
            // cilia
            ctx.strokeStyle='rgba(255,255,255,0.4)'; ctx.lineWidth=Math.max(1,r*0.04);
            for(let i=0;i<10;i++){let ang=(Math.PI*2/10)*i,w=Math.sin(t*6+i)*0.2;ctx.beginPath();ctx.moveTo(Math.cos(ang)*r*0.7,Math.sin(ang)*r*0.9);ctx.lineTo(Math.cos(ang)*r*(0.7+0.3+w),Math.sin(ang)*r*(0.9+0.3+w));ctx.stroke();}
            break;
        }
        case 'Gonium': { // Gonium ‚Äî flat plate of 16 cells
            let nc=16, cols=4;
            let sub=r*0.28;
            for(let i=0;i<nc;i++){
                let col=i%cols, row=Math.floor(i/cols);
                let ox=x+(col-1.5)*sub*2.1, oy=y+(row-1.5)*sub*2.1;
                ctx.fillStyle=c; ctx.beginPath(); ctx.arc(ox,oy,sub,0,Math.PI*2); ctx.fill();
                ctx.strokeStyle='rgba(255,255,255,0.3)'; ctx.lineWidth=1; ctx.stroke();
                // flagella
                ctx.strokeStyle='rgba(255,255,255,0.5)'; ctx.lineWidth=1;
                ctx.beginPath(); ctx.moveTo(ox,oy-sub);
                for(let j=0;j<=5;j++){let jt=j/5;ctx.lineTo(ox+Math.sin(jt*Math.PI*2+t*4+i)*sub*0.4,oy-sub-jt*sub*0.8);}
                ctx.stroke();
            }
            break;
        }
        case 'Stenty': { // Stentor ‚Äî trumpet / wine-glass shape
            ctx.translate(x,y); ctx.rotate(Math.PI/2+Math.sin(t*0.5)*0.2);
            ctx.fillStyle=c+'dd';
            ctx.beginPath(); ctx.moveTo(-r,0); ctx.bezierCurveTo(-r,-r*0.6,r*0.2,-r*0.9,r*0.15,-r*1.0);
            ctx.lineTo(0,-r); ctx.bezierCurveTo(r*0.4,-r*0.8,r*0.6,-r*0.2,r*0.6,0);
            ctx.bezierCurveTo(r*0.6,r*0.3,r*0.3,r*0.5,0,r*0.6); ctx.bezierCurveTo(-r*0.4,r*0.5,-r,r*0.3,-r,0);
            ctx.fill();
            // oral cilia crown at wide end (left)
            ctx.strokeStyle='rgba(255,255,255,0.7)'; ctx.lineWidth=Math.max(1,r*0.05);
            for(let i=0;i<10;i++){let a=-Math.PI/2+((i/10)*Math.PI),wv=Math.sin(t*5+i)*r*0.2;ctx.beginPath();ctx.moveTo(-r,Math.sin(a)*r*0.5);ctx.lineTo(-r-r*0.25+wv,Math.sin(a)*r*0.65);ctx.stroke();}
            break;
        }
        case 'Peri': { // Peridinium ‚Äî armored plates, angular
            ctx.translate(x,y);
            // main body in plates
            ctx.fillStyle=c;
            let plates=8;
            ctx.beginPath();
            for(let i=0;i<plates;i++){
                let a=(Math.PI*2/plates)*i, ra=i%2===0?r:r*0.88;
                i===0?ctx.moveTo(Math.cos(a)*ra,Math.sin(a)*ra):ctx.lineTo(Math.cos(a)*ra,Math.sin(a)*ra);
            }
            ctx.closePath(); ctx.fill();
            // plate suture lines
            ctx.strokeStyle='rgba(0,0,0,0.4)'; ctx.lineWidth=r*0.08;
            for(let i=0;i<plates;i++){let a=(Math.PI*2/plates)*i;ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(Math.cos(a)*r,Math.sin(a)*r);ctx.stroke();}
            // two flagella in groove
            ctx.strokeStyle='rgba(255,255,255,0.6)'; ctx.lineWidth=Math.max(1,r*0.05);
            ctx.beginPath(); ctx.ellipse(0,0,r,r*0.12,0,0,Math.PI*2); ctx.stroke();
            break;
        }
        case 'Gromia': { // Gromia ‚Äî perfect sphere with pseudopod rays
            ctx.fillStyle=c;
            ctx.beginPath(); ctx.arc(x,y,r*0.8,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle='rgba(255,255,255,0.5)'; ctx.lineWidth=2; ctx.stroke();
            // thin reticulopods radiating out
            ctx.strokeStyle='rgba(255,220,150,0.7)'; ctx.lineWidth=Math.max(1,r*0.04);
            for(let i=0;i<12;i++){
                let ang=(Math.PI*2/12)*i, len=r*(1.2+0.4*Math.sin(t*0.8+i));
                ctx.beginPath(); ctx.moveTo(x+Math.cos(ang)*r*0.8,y+Math.sin(ang)*r*0.8);
                ctx.lineTo(x+Math.cos(ang)*len,y+Math.sin(ang)*len); ctx.stroke();
            }
            break;
        }
        case 'Arcey': { // Arcella ‚Äî dome shell with pore opening
            ctx.translate(x,y);
            // dome shell (top half)
            ctx.fillStyle='#a1887f';
            ctx.beginPath(); ctx.arc(0,0,r,Math.PI,0); ctx.fill();
            ctx.strokeStyle='#6d4c41'; ctx.lineWidth=3; ctx.stroke();
            // cell body inside
            ctx.fillStyle=c+'aa';
            ctx.beginPath(); ctx.arc(0,-r*0.15,r*0.7,0,Math.PI*2); ctx.fill();
            // pore opening at bottom
            ctx.fillStyle='#3e2723';
            ctx.beginPath(); ctx.arc(0,0,r*0.35,0,Math.PI); ctx.fill();
            // pseudopods reaching out of pore
            ctx.strokeStyle=c; ctx.lineWidth=Math.max(2,r*0.1);
            for(let i=-1;i<=1;i++){let ang=Math.PI/2+i*0.5+Math.sin(t+i)*0.3;ctx.beginPath();ctx.moveTo(Math.cos(Math.PI/2+i*0.5)*r*0.3,Math.sin(Math.PI/2+i*0.5)*r*0.3);ctx.lineTo(Math.cos(ang)*r*0.9,Math.sin(ang)*r*0.8);ctx.stroke();}
            break;
        }
        case 'Cilia': { // Generic cilia cell ‚Äî oval covered in cilia
            ctx.translate(x,y); ctx.rotate(Math.sin(t*0.4)*0.3);
            ctx.fillStyle=c;
            ctx.beginPath(); ctx.ellipse(0,0,r*0.65,r,0,0,Math.PI*2); ctx.fill();
            // dense cilia all around
            ctx.strokeStyle='rgba(255,255,255,0.55)'; ctx.lineWidth=Math.max(1,r*0.04);
            let cn=20;
            for(let i=0;i<cn;i++){
                let ang=(Math.PI*2/cn)*i, wave=Math.sin(t*7+i*1.1)*0.3;
                let bx=Math.cos(ang)*r*0.65, by=Math.sin(ang)*r;
                ctx.beginPath(); ctx.moveTo(bx,by);
                ctx.lineTo(bx*(1+0.4+wave),by*(1+0.4+wave)); ctx.stroke();
            }
            break;
        }
        default: { // Fallback plain circle
            ctx.fillStyle=c; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
            break;
        }
    }
 
    // Aggro red ring
    if(b.aggro){
        ctx.restore(); ctx.save();
        ctx.strokeStyle='#b71c1c'; ctx.lineWidth=Math.max(2,b.r*0.1);
        ctx.beginPath(); ctx.arc(b.x,b.y,b.r+2,0,Math.PI*2); ctx.stroke();
    }
    // Name label
    if(b.r>14){
        ctx.restore(); ctx.save();
        ctx.fillStyle='white'; ctx.font=`bold ${Math.min(b.r*0.38,14)}px Segoe UI`;
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.shadowColor='rgba(0,0,0,0.8)'; ctx.shadowBlur=3;
        ctx.fillText(b.name,b.x,b.y+b.r*1.35);
    }
    ctx.restore();
}
 
function drawPlayerCell(c){
    const shieldOn=Date.now()<shieldEndTime;
    if(shieldOn){
        let pulse=0.5+0.5*Math.sin(Date.now()/150);
        ctx.strokeStyle=`rgba(80,170,255,${pulse})`;ctx.lineWidth=10;ctx.beginPath();ctx.arc(c.x,c.y,c.r+12,0,Math.PI*2);ctx.stroke();
        ctx.strokeStyle=`rgba(180,220,255,${pulse*0.4})`;ctx.lineWidth=18;ctx.beginPath();ctx.arc(c.x,c.y,c.r+20,0,Math.PI*2);ctx.stroke();
    }
    ctx.fillStyle='#0288d1';ctx.beginPath();ctx.arc(c.x,c.y,c.r,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#fff';ctx.lineWidth=4;ctx.stroke();
    if(c.r>20){if(hasChloroplasts)drawChloroplasts(c.x,c.y,c.r);if(hasMitochondria)drawMitochondria(c.x,c.y,c.r);if(hasNucleus)drawNucleus(c.x,c.y,c.r);}
    if(c.r>15){
        ctx.fillStyle='white';ctx.font=`bold ${Math.min(c.r*0.32,16)}px Segoe UI`;ctx.textAlign='center';ctx.textBaseline='middle';
        let labelY=(hasNucleus&&c.r>22)?c.y+c.r*0.62:c.y;ctx.fillText('YOU',c.x,labelY);
    }
}
 
function isVisible(x,y,r){let sx=(x-avgX)*cameraZoom+width/2,sy=(y-avgY)*cameraZoom+height/2,sr=r*cameraZoom;return sx+sr>0&&sx-sr<width&&sy+sr>0&&sy-sr<height;}
 
// ‚îÄ‚îÄ Draw ‚îÄ‚îÄ
function draw(){
    if(!gameActive) return;
    ctx.fillStyle='#f0f4f7';ctx.fillRect(0,0,width,height);
 
    if(playerCells.length>0){
        avgX=playerCells.reduce((s,c)=>s+c.x,0)/playerCells.length;
        avgY=playerCells.reduce((s,c)=>s+c.y,0)/playerCells.length;
    }
 
    ctx.save();
    ctx.translate(width/2,height/2);ctx.scale(cameraZoom,cameraZoom);ctx.translate(-avgX,-avgY);
 
    // Grid
    ctx.strokeStyle='#d1d9e0';ctx.lineWidth=2;
    let vL=avgX-width/2/cameraZoom-200,vR=avgX+width/2/cameraZoom+200;
    let vT=avgY-height/2/cameraZoom-200,vB=avgY+height/2/cameraZoom+200;
    for(let x=Math.max(0,(vL/200|0)*200);x<=Math.min(WORLD_SIZE,vR);x+=200){ctx.beginPath();ctx.moveTo(x,Math.max(0,vT));ctx.lineTo(x,Math.min(WORLD_SIZE,vB));ctx.stroke();}
    for(let y=Math.max(0,(vT/200|0)*200);y<=Math.min(WORLD_SIZE,vB);y+=200){ctx.beginPath();ctx.moveTo(Math.max(0,vL),y);ctx.lineTo(Math.min(WORLD_SIZE,vR),y);ctx.stroke();}
    ctx.strokeStyle='#37474f';ctx.lineWidth=20;ctx.strokeRect(0,0,WORLD_SIZE,WORLD_SIZE);
 
    // Food
    for(let f of food){
        if(!isVisible(f.x,f.y,f.r))continue;
        ctx.fillStyle=hasChloroplasts?`hsl(${Math.random()*40+100},70%,55%)`:f.c;
        ctx.beginPath();ctx.arc(f.x,f.y,f.r,0,Math.PI*2);ctx.fill();
    }
 
    // ATP
    for(let a of atp){
        if(!isVisible(a.x,a.y,a.r*2))continue;
        ctx.fillStyle='#ffea00';ctx.beginPath();
        ctx.moveTo(a.x,a.y-a.r);ctx.lineTo(a.x+a.r,a.y);ctx.lineTo(a.x,a.y+a.r);ctx.lineTo(a.x-a.r,a.y);
        ctx.closePath();ctx.fill();
    }
 
    // Green viruses
    for(let v of viruses){
        if(!isVisible(v.x,v.y,v.r))continue;
        ctx.fillStyle='#4caf50';ctx.beginPath();
        for(let i=0;i<16;i++){let a=(Math.PI*2/16)*i,r=i%2===0?v.r:v.r*0.8;ctx.lineTo(v.x+Math.cos(a)*r,v.y+Math.sin(a)*r);}
        ctx.fill();ctx.strokeStyle='#1b5e20';ctx.lineWidth=3;ctx.stroke();
    }
 
    // ‚îÄ‚îÄ Black Viruses ‚îÄ‚îÄ
    for(let bv of blackViruses){
        if(!isVisible(bv.x,bv.y,bv.r+20))continue;
        let pulse=0.5+0.5*Math.sin(bv.pulseT);
        // Glow
        let grd=ctx.createRadialGradient(bv.x,bv.y,bv.r*0.3,bv.x,bv.y,bv.r*2.2);
        grd.addColorStop(0,`rgba(80,0,180,${0.25+pulse*0.2})`);
        grd.addColorStop(1,'rgba(0,0,0,0)');
        ctx.fillStyle=grd;ctx.beginPath();ctx.arc(bv.x,bv.y,bv.r*2.2,0,Math.PI*2);ctx.fill();
        // Body spiky
        ctx.fillStyle='#0a0a0a';ctx.beginPath();
        for(let i=0;i<20;i++){let a=(Math.PI*2/20)*i,r=i%2===0?bv.r:bv.r*0.78;ctx.lineTo(bv.x+Math.cos(a)*r,bv.y+Math.sin(a)*r);}
        ctx.fill();
        ctx.strokeStyle=`rgba(140,0,255,${0.5+pulse*0.5})`;ctx.lineWidth=3+pulse*3;ctx.stroke();
        // Inner glow ring
        ctx.strokeStyle=`rgba(200,100,255,${0.3+pulse*0.4})`;ctx.lineWidth=2;
        ctx.beginPath();ctx.arc(bv.x,bv.y,bv.r*0.55,0,Math.PI*2);ctx.stroke();
        // Label
        ctx.fillStyle='rgba(200,100,255,0.9)';ctx.font='bold 11px Segoe UI';ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText('20K‚¨Ü',bv.x,bv.y);
    }
 
    // ‚îÄ‚îÄ Red Viruses ‚îÄ‚îÄ
    for(let rv of redViruses){
        if(!isVisible(rv.x,rv.y,rv.r+15))continue;
        let pulse=0.5+0.5*Math.sin(rv.pulseT);
        // Glow
        let grd2=ctx.createRadialGradient(rv.x,rv.y,rv.r*0.3,rv.x,rv.y,rv.r*2);
        grd2.addColorStop(0,`rgba(255,0,0,${0.2+pulse*0.2})`);
        grd2.addColorStop(1,'rgba(0,0,0,0)');
        ctx.fillStyle=grd2;ctx.beginPath();ctx.arc(rv.x,rv.y,rv.r*2,0,Math.PI*2);ctx.fill();
        // Body spiky
        ctx.fillStyle='#c62828';ctx.beginPath();
        for(let i=0;i<14;i++){let a=(Math.PI*2/14)*i,r=i%2===0?rv.r:rv.r*0.75;ctx.lineTo(rv.x+Math.cos(a)*r,rv.y+Math.sin(a)*r);}
        ctx.fill();
        ctx.strokeStyle=`rgba(255,80,80,${0.6+pulse*0.4})`;ctx.lineWidth=2+pulse*2;ctx.stroke();
        // Label
        ctx.fillStyle='white';ctx.font='bold 10px Segoe UI';ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText('‚àí20%',rv.x,rv.y-5);
        ctx.font='9px Segoe UI';ctx.fillStyle='rgba(255,200,200,0.8)';
        ctx.fillText('10K‚¨Ü',rv.x,rv.y+7);
    }
 
    // Bots ‚Äî stylized cell-accurate shapes
    for(let b of bots){
        if(!isVisible(b.x,b.y,b.r))continue;
        drawBot(b);
    }
 
    // Particles
    for(let p of particles){ctx.fillStyle=`rgba(0,229,255,${p.life})`;ctx.beginPath();ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fill();}
 
    // Player
    for(let c of playerCells) drawPlayerCell(c);
 
    ctx.restore();
 
    // Minimap
    const ms=(isMobile?110:130)/WORLD_SIZE;
    mCtx.clearRect(0,0,150,150);
    for(let v of viruses){mCtx.fillStyle='#4caf50';mCtx.fillRect(v.x*ms-1,v.y*ms-1,3,3);}
    for(let bv of blackViruses){mCtx.fillStyle='#9c27b0';mCtx.fillRect(bv.x*ms-3,bv.y*ms-3,6,6);}
    for(let rv of redViruses){mCtx.fillStyle='#e53935';mCtx.fillRect(rv.x*ms-2,rv.y*ms-2,5,5);}
    for(let b of bots){mCtx.fillStyle=b.aggro?'#e53935':'#ff9800';mCtx.fillRect(b.x*ms-1,b.y*ms-1,2,2);}
    for(let c of playerCells){mCtx.fillStyle='#00e5ff';mCtx.fillRect(c.x*ms-2,c.y*ms-2,5,5);}
 
    update();
    requestAnimationFrame(draw);
}
 
function startGame(){
    document.getElementById('overlay').style.display='none';
    victoryScreen.style.display='none';
    deathScreen.style.display='none';
    gameActive=true; init(); draw();
}
document.getElementById('startBtn').onclick=startGame;
document.getElementById('respawnBtn').onclick=startGame;
document.getElementById('victoryBtn').onclick=startGame;
</script>
</body>
</html>
 
